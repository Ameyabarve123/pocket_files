import { NextRequest, NextResponse } from "next/server";
import { createClient } from "@/lib/supabase/server";
import { redirect } from "next/navigation";
import { GoogleGenAI } from "@google/genai";

export async function GET(req: NextRequest) {
  try {
    const supabase = await createClient();

    // Check auth
    const { data: { user }, error: authError } = await supabase.auth.getUser();
    if (authError || !user?.id) {
      return redirect("/login");
    }

    // Extract text from ?query=...
    const { searchParams } = new URL(req.url);
    const query = searchParams.get("query");

    if (!query) {
      return NextResponse.json(
        { error: "Missing 'query' parameter" },
        { status: 400 }
      );
    }

    // Generate embedding
    const ai = new GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY });
    const result = await ai.models.embedContent({
      model: "models/text-embedding-004",
      contents: query,
      config: {
        taskType: "SEMANTIC_SIMILARITY",
        outputDimensionality: 768,
      },
    });

    const embeddingValues = result?.embeddings?.[0]?.values;
    // console.log("Generated embedding:", embeddingValues);

    if (!embeddingValues) {
      return NextResponse.json(
        { error: "Failed to generate embedding" },
        { status: 500 }
      );
    }
    const testVector = '[-0.021522326,0.0033239063,-0.0010990351,-0.059293076,-0.01763009,-0.01633174,-0.01279131,0.0066103777,-0.0022833294,-0.0069906847,0.0037722625,-0.0147898765,-0.035810288,0.0009555827,0.12998794,-0.034481335,0.0008777445,0.0060778325,0.0056416523,-0.029987898,0.0016095253,0.01636728,-0.010190888,-0.005582804,0.00897149,-0.015236553,0.016137546,0.023514356,0.0024962346,-0.008825648,-0.010994158,0.034708824,0.0037032333,-0.004322938,0.018074587,0.008819239,0.023317687,0.01138226,-0.0028785511,0.038397703,-0.0011620655,0.0027801048,-0.0010435355,0.012879098,-0.0012509556,-0.002406168,0.007374616,0.009223474,0.021976812,0.039109677,-0.034486204,0.008648478,0.0077609485,-0.17346184,0.0038081908,-0.010329804,-0.0264826,0.0151559375,-0.0043634623,0.004172861,0.001275261,0.0284954,-0.032369453,-0.02672482,-0.006276742,-0.036293305,0.015892962,-0.0110884085,-0.032038722,0.02075948,-0.005674749,-0.017374389,-0.009777218,0.012244181,-0.010558743,-0.031671837,0.022378076,0.027318962,0.0046804463,0.02730917,0.017842542,-0.012059685,-0.0048660096,-0.01195499,-0.016535297,0.021808928,-0.04115029,-0.019008929,-0.021119425,-0.011063943,-0.0006700538,-0.005739254,0.0022611492,0.008763385,-0.031768654,-0.005340697,-0.0010293825,-0.0038568755,-0.032359917,0.004979486,-0.017525103,-0.024960777,-0.015612232,-0.0270449,0.005783998,-0.036808018,0.012768079,-0.009290209,0.004656351,0.022696849,-0.024560552,0.010399626,0.0047243778,0.026228223,0.02165846,-0.1573367,0.012380969,0.009234637,0.0051009064,0.0026985817,0.0059983754,0.0070491433,0.028426524,0.018666498,-0.0030791156,-0.0020940122,0.014320905,-0.014543881,-0.010300789,0.01925144,0.01661284,-0.011379308,-0.0047387034,0.017025921,-0.02206856,0.029585361,0.0056833765,0.018806692,0.0077729346,-0.015934244,0.010543774,0.012734613,-0.0013175368,-0.0050054747,-0.008648879,-0.014480945,-0.022264466,0.005865676,0.024542248,-0.022504479,-0.0035584918,-0.0065234164,-0.0024998488,0.0001368966,0.0020116463,-0.09094929,-0.016376747,0.01097414,0.017545342,-0.0034305518,-0.003946314,0.0028055748,0.017867913,-0.0004708861,0.012878973,-0.021432048,0.01939474,-0.014917132,0.023954729,0.0052449116,0.0059204344,-0.008316049,0.0015703693,0.024292232,0.010217316,0.010288553,-0.0023003654,0.010058348,0.020426098,0.023113599,-0.005511519,-0.006251088,0.013715393,0.0052033165,-0.0014733729,-0.0095600765,-0.042970344,-0.0013861916,0.008727616,-0.00017273442,-0.01239469,0.01057951,-0.012541795,0.003309928,-0.0011919899,0.028787136,0.02455919,0.032421682,0.005882736,-0.0036477523,-0.0017756397,0.017929612,0.027695537,-0.00042209044,0.0054186806,-0.012257153,-0.009990666,-0.006496328,-0.0023366418,0.018326435,0.013252411,0.0018860736,0.025878068,-0.031849276,0.016846847,0.012859304,0.0068209353,0.020226886,-0.0002537467,0.004911296,0.04060364,-0.036524504,0.0017456212,-0.006755279,-0.025863674,-0.025933994,-0.0006595683,0.015409087,-0.002431268,-0.0030157582,-0.009146771,-0.013774718,-0.009124445,0.003470601,0.016945148,0.007281413,0.014165414,0.027851535,0.005347988,0.0013465002,0.00065331405,-0.014220351,0.008719779,-0.004108678,0.013500792,-0.0134500945,-0.015539294,0.008106835,-0.012871835,0.0009778197,0.006200825,-0.02331052,0.010405484,-0.031940818,-0.004317624,0.006837239,-0.03653178,0.0012785393,0.029023727,-0.00868414,-0.009680249,-0.008247112,-0.002402634,-0.037988734,0.002330406,-0.009027317,0.0056198463,0.005403956,-0.021603052,0.028351596,0.019986462,0.012076324,-0.0021597643,-0.007172998,-0.016851198,0.0018739635,-0.080070235,0.017325014,-0.010278214,0.0075655095,0.006255838,-0.0036247817,0.008216414,-0.01114102,-0.010245042,0.001823726,-0.013651151,-0.0045076297,0.011977475,-0.00419789,0.015748413,0.04116245,-0.014060666,0.040228017,0.012584836,-0.03089723,-0.01461914,-0.02213866,0.009404011,0.024132447,0.008985268,-0.048510917,0.009392798,0.05392595,0.007956175,0.012498329,0.015629815,0.011627486,0.005735089,-0.0070720324,0.00668109,-0.0025228227,-0.033388566,0.00840321,0.035635695,-0.03263681,0.02799706,-0.002233336,0.0032967774,0.010267658,0.0013663635,-0.010432204,-0.0030799066,-0.022264015,-0.0005041143,0.0052753096,0.0056866,0.0065899757,0.013415449,-0.038485765,0.019715365,0.0047064815,0.028095951,-0.007800767,-0.002067516,-0.0029366699,-0.012621158,0.024271818,-0.00021629475,0.0115519045,-0.0045944997,0.0017156427,0.013921407,-0.015100174,-0.03113087,0.00785919,0.0029879673,0.0050074095,0.002971329,-0.023499614,-0.0044312924,0.020019623,-0.019558312,0.0049347696,-0.017844077,0.02762926,0.014708409,-0.012771068,-0.007894856,0.019440994,-0.024741272,0.004993893,0.010720273,0.011920651,-0.0003555802,-0.013198184,0.003943453,0.008677055,-0.019393694,0.011061307,-0.0047740275,0.0375358,0.033583473,0.005698268,-0.03069768,-0.012769841,-0.03569869,-0.002060042,0.008688531,0.016888943,-0.00014116873,0.008415701,0.004172895,0.02691828,-0.007971648,0.016944908,0.019057795,-0.006325727,0.005341608,-0.034633137,-0.015093671,0.028330639,-0.011949054,0.01852696,-0.020446949,0.001302583,-4.5094734e-05,-0.012607402,0.010834623,0.0033217377,0.009079094,-0.014737163,-0.022408042,-0.014071991,-0.0006523433,-0.010326735,-0.0098661715,0.016017452,0.003941167,0.016248384,-0.0036990303,-0.016013004,-0.009488728,-0.0015098365,0.015136834,0.0043438924,-0.027760265,-0.0139333485,0.0015142203,-0.007337871,-0.0024979103,0.030105757,-0.003919772,0.03341224,-0.023172308,-0.030690402,-0.014925474,-0.008010389,0.012387959,0.0059939935,0.0009914903,-0.035059012,-0.0040925173,-0.012318443,0.0024664872,-0.00034373757,-0.018659975,0.019718448,0.0016659979,-0.0002861836,0.0006799806,0.018387726,0.016580917,0.0076033776,0.017998112,0.013249198,-0.010174112,0.0026938564,-0.020991933,-0.01224223,-0.017431164,-0.0060608606,-0.011653354,-0.0044487375,0.0392169,0.021249367,-0.009684071,-0.0059747137,0.013140582,-0.013119033,-0.0029025876,-0.026129516,0.004253816,0.013687114,-0.018502528,0.0018604135,0.012737533,-0.014348632,0.00089017104,0.008926992,-0.020470252,0.01767951,0.019703683,0.013413903,0.0015919993,0.017815314,-0.008166501,-0.008988191,-0.00078785775,-0.01977014,0.001454512,0.007801382,0.0069083837,0.008003169,-0.0050316146,0.025411582,-0.0009866599,0.011363509,-0.01558374,-0.006720865,0.01712862,0.011606864,-0.014815971,0.012272904,-0.009072671,-0.023247225,0.0024822426,-0.018343681,-0.017777788,-0.020249724,0.037528373,0.030199207,0.00456519,-0.019152831,-0.00997708,-0.00037237484,0.016007166,-0.033677287,0.0042782584,-0.006264226,-0.0060127536,-0.024886338,0.019732218,0.02674042,-0.01877474,0.034836195,-0.022779567,0.01406257,0.011426399,0.01852873,-0.020684887,-0.0070748236,-0.00019228138,-0.020237006,-0.008232008,0.015382106,0.010809406,0.037823368,0.014329918,-0.0020472212,-0.010029705,0.022326887,0.0026650236,-0.005359827,0.005894015,0.011318932,0.004784421,0.013858354,0.010476904,-0.017535357,0.0030177617,0.020300379,-0.011973915,-0.01859168,0.018879736,-0.13351205,0.020869374,-0.013164712,-0.0012574886,-0.02700947,0.0050435807,-0.0005815229,-0.017495679,0.009407834,-0.0044355453,0.025516875,-0.004845569,-0.003684672,0.011066008,-0.0064856815,0.0021764198,-0.018684026,-0.010795546,0.031162454,-0.027626054,-0.00051569036,0.020474037,0.016582267,0.0073979227,0.010047169,0.0139822215,0.03264653,0.002979761,-0.015668891,-0.0018688142,-0.0156185,0.015926404,-0.0089085065,0.0043582097,-0.0039721825,0.008926037,0.013858425,0.011917595,-0.0029541964,0.017113006,-0.0067652827,0.009553404,0.0006412654,-0.021631418,-0.013271294,-0.005067988,0.0022661737,-0.018249016,-0.0010578702,-0.030338557,0.001990118,0.03617228,0.002891794,-0.00191814,-0.015434407,-0.0064478256,-0.013625598,0.019324204,-0.012397262,0.0041013514,1.1065585e-05,0.004578873,0.030072097,0.009509415,0.005129851,0.00285604,0.003090446,-0.008133577,0.00022257825,-0.0036827275,-0.0032288253,-0.026267126,0.004882827,0.00078934245,0.015093622,0.0064973813,-0.031319935,0.014958599,-0.002686523,-0.016790805,-0.03626994,-0.00895412,-0.07590532,-0.008322175,-0.003113754,0.03498577,0.015582647,0.0074524353,-0.0062639113,-0.0003970248,-0.0177551,0.022681165,-0.01285897,0.0030111868,-0.00013355035,0.004433573,-0.000313894,-0.00018662329,-0.0063457624,-0.003024585,0.021115812,-0.0036058095,-0.006955762,-0.00018952796,0.004958541,-0.009020537,0.0074402667,0.005235454,-0.0052202423,-0.011990368,0.004639098,-0.012436087,-0.007921904,-0.1102603,0.003127932,-0.015610027,0.018669622,0.034398574,-0.012001813,-0.011324297,0.0040200907,-0.00347809,-0.016057312,-0.010362431,-0.025488425,0.002347613,-0.0001346136,0.016681645,0.13688518,-0.022338651,0.0057572583,-0.0076712254,-0.010047316,-0.0026794777,-0.016982267,-0.019758957,0.00038130934,0.023499038,0.014095305,0.021995822,-0.012989506,-0.011589941,0.0077316845,0.0013324938,0.014722987,-0.005692034,0.008777259,-0.0054889843,0.020761205,-0.011914861,-0.016725853,-0.007913476,-0.01493084,0.02517391,0.013460622,-0.01024021,0.0077192164,-0.0049777427,-0.012737082,-0.0045567164,0.008688321,0.0052060727,0.0044451226,-0.031981114,-0.05311999,-0.0016566912,0.015174085,0.011117203,0.002169028,-0.005151444,0.0028912665,0.024678739,0.014992946,-0.02228816,0.015223266,-0.0074083987,0.02033726,-0.011489691,0.01797488,-0.014007691,-0.0048657204,0.0066357,-0.01993929,0.008242719,0.016260888,0.004621234,0.006673595,-0.00452626,-0.00394061,0.009719775,-0.009031025,0.0027651165,-0.009285254,0.0012164414,-0.01924216,-0.01031384,0.0059499145,0.0061609913,-0.017057722,-0.008600295,-0.0059750825,0.001092939,-0.019414736,-0.0012310457,0.011552178,0.015763743,-0.017866619,-0.01922767,-0.0017701777,0.015391199,-0.014764678,-0.0008898208,0.008424046,0.0056123,-0.0035665864,0.031222027,-0.03514348,-0.015491828,-0.008981419,-0.0069136503,0.019127892,0.024441434,0.0112363165]';
    // Vector similarity search on "storage_nodes"
    
    const { data, error } = await supabase.rpc('match_documents', {
      query_embedding: testVector, // Format as string
      match_count: 10
    });

    if (error) {
      return NextResponse.json({ error: error.message }, { status: 500 });
    }

    return NextResponse.json({ results: data });
  } catch (error) {
    console.error("Get error:", error);
    return NextResponse.json(
      { error: "Internal Server Error" },
      { status: 500 }
    );
  }
}
